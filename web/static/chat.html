<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
<title>Multi-Agent Hub</title>
<style>
:root{
  --bg:#fff;
  --text:#1f2937;
  --muted:#6b7280;
  --border:#e5e7eb;
  --panel:#fff;
  --panel-2:#f8fafc;

  --green:#10b981;
  --green-50:#ecfdf5;
  --green-100:#d1fae5;
}

/* 基础 */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans CJK SC",sans-serif;
}

/* 布局 */
.app{display:flex; height:100vh; overflow:hidden}
.sidebar{
  width:280px; flex:0 0 280px;
  background:var(--panel);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column;
}
.main{flex:1; display:flex; flex-direction:column; background:var(--panel)}

.brand{
  display:flex; align-items:center; gap:10px;
  padding:14px 16px; border-bottom:1px solid var(--border);
}
.brand img{width:22px;height:22px;object-fit:contain}
.brand h1{margin:0; font-size:16px; font-weight:600}

.side-tools{display:flex; gap:8px; padding:12px 12px 8px}
.btn{
  padding:8px 12px; border:1px solid var(--border);
  background:#fff; color:var(--text);
  border-radius:8px; cursor:pointer;
}
.btn:hover{filter:brightness(0.98)}
.btn:active{transform:translateY(0.5px)}
.btn.btn-green{background:var(--green); border-color:var(--green); color:#fff}
.btn.btn-danger{background:#ef4444; border-color:#ef4444; color:#fff}

.session-list{overflow:auto; padding:6px 8px 12px}
.session-item{
  position:relative;
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; padding:10px 12px;
  border:1px solid var(--border); background:#fff;
  border-radius:10px; margin:8px 0; cursor:pointer;
}
.session-item:hover{background:var(--panel-2)}
.session-item.active{outline:2px solid var(--green-100); background:var(--green-50)}
.session-title{
  min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  font-weight:600; font-size:13px;
}
.session-actions{display:flex; align-items:center}
.session-actions .btn-del{
  /* 无边框的“×”图标按钮 */
  width:22px; height:22px;
  display:inline-flex; align-items:center; justify-content:center;
  background:transparent; border:none; outline:none; cursor:pointer;
  color:#9ca3af; font-size:16px; line-height:1;
  border-radius:6px;
  transition:transform .15s ease, color .15s ease, background .15s ease;
}
.session-actions .btn-del:hover{
  color:#ef4444; background:#fee2e2;
}
.session-actions .btn-del:active{ transform:scale(0.95); }

/* 工具栏 */
.toolbar{
  display:flex; align-items:center; gap:14px;margin: 12px 10%;
  padding: 10px 56px; border-bottom:1px solid var(--border); background:#fff;
}
.toolbar .muted{color:var(--muted); font-size:12px; margin-left: 40%;}

/* 聊天区 */
.chat{
  flex:1; overflow:auto; padding:18px 20px 24px;
  background:#f6f6f6;
  margin:0 10%;
}

/* —— 消息行 —— */
.msg{
  display:flex; gap:10px; margin:12px 0;
  align-items:flex-start; /* 头像与气泡顶部齐平 */
}
.msg .avatar{
  width:40px; height:40px;
  border-radius:8px;            /* 轻微圆角，不是圆形 */
  border:1px solid var(--border);
  background:#fff; overflow:hidden;
  flex:0 0 40px;
}
.msg .avatar img{width:100%; height:100%; object-fit:cover}

/* 气泡 */
.bubble{
  max-width:760px;
  border:1px solid var(--border);
  background:#fff;
  border-radius:10px;           /* 轻微圆角 */
  padding:10px 12px;
  word-break:break-word; white-space:pre-wrap;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
}

/* 用户（右侧） */
.msg.user{justify-content:flex-end}
.msg.user .avatar{order:2; margin-left:8px}
.msg.user .bubble{
  order:1;
  background:var(--green-50);
  border-color:#a7f3d0;
}

/* 助手（左侧） */
.msg.assistant{justify-content:flex-start}
.msg.assistant .avatar{margin-right:8px}
.msg.assistant .bubble{background:#fff; border-color:var(--border)}

/* 系统提示：灰色小字，无边框、无头像，居中窄行 */
.msg.system{
  justify-content:center; margin:16px 0;
}
.msg.system .bubble{
  background:transparent; border:none; box-shadow:none;
  color:var(--muted); font-size:12px; padding:0; max-width:640px;
  text-align:center;
}

/* 代码块/预格式文本（可选） */
.bubble pre{
  margin:8px 0; padding:10px; background:#f8fafc; border:1px solid var(--border);
  border-radius:8px; overflow:auto;
}

/* 输入区（发送按钮在文本框内右下角悬浮） */
.composer{
  position:relative;
  display:flex; gap:10px; padding:20px 0; border-top:1px solid var(--border);
  background:#fff; margin:0 10%;
}
.composer textarea{
  flex:1; min-height:92px; resize:vertical;
  border:1px solid var(--border); border-radius:12px;
  padding:12px 56px 12px 12px; /* 右侧为悬浮按钮留白 */
  outline:none; background:#fff;
}
.composer textarea:focus{border-color:#86efac; box-shadow:0 0 0 3px rgba(16,185,129,.15)}
/* 圆形悬浮发送按钮 */
#send{
  position:absolute; right:24px; bottom:24px;
  width:40px; height:40px; border-radius:12px;
  border:none; cursor:pointer;
  background:var(--green); color:#fff;
  display:inline-flex; align-items:center; justify-content:center;
  box-shadow:0 6px 14px rgba(16,185,129,.25);
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
#send:hover{ filter:brightness(.98); box-shadow:0 8px 18px rgba(16,185,129,.3); }
#send:active{ transform:translateY(1px); }
#send svg{ width:18px; height:18px; }

/* RAG 来源块（简约） */
.sources{ margin-top:8px; padding:8px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; }
.sources .source-item + .source-item{ margin-top:6px; }
.sources a{ color:#047857; text-decoration:none; }
.sources a:hover{ text-decoration:underline; }
.sources .muted{ color:#6b7280; font-size:12px; }

/* 滚动条（可选） */
.chat::-webkit-scrollbar,.session-list::-webkit-scrollbar{ width:8px; height:8px }
.chat::-webkit-scrollbar-thumb,.session-list::-webkit-scrollbar-thumb{ background:#e5e7eb; border-radius:8px }
.chat::-webkit-scrollbar-thumb:hover,.session-list::-webkit-scrollbar-thumb:hover{ background:#d1d5db }

/* 自定义弹窗 */
.modal-mask{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
.modal{
  width:420px; background:#fff; border:1px solid var(--border); border-radius:12px;
  box-shadow:0 12px 30px rgba(0,0,0,.12); overflow:hidden;
}
.modal .hd{ padding:14px 16px; font-weight:600; border-bottom:1px solid var(--border); }
.modal .bd{ padding:16px; color:#374151; }
.modal .ft{ padding:12px 16px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid var(--border); }
</style>
</head>
<body>
<!-- 自定义确认框 -->
<div id="confirmMask" class="modal-mask">
  <div class="modal">
    <div class="hd">确认</div>
    <div class="bd" id="confirmMsg">确定吗？</div>
    <div class="ft">
      <button class="btn" id="confirmCancel">取消</button>
      <button class="btn btn-green" id="confirmOk">确定</button>
    </div>
  </div>
</div>

<div class="app">
  <!-- 左侧 -->
  <aside class="sidebar">
    <div class="brand">
      <img src="/static/images/logo.png" alt="logo" />
      <h1>Multi-Agent Hub</h1>
    </div>
    <div class="side-tools">
      <button id="btn-new" class="btn btn-green">新建会话</button>
      <button id="btn-clear-all" class="btn btn-danger" style="display:none">清空全部</button>
    </div>
    <div id="session-list" class="session-list"></div>
  </aside>

  <!-- 右侧 -->
  <main class="main">
    <div class="toolbar">
      <label>模型:
        <select id="model-select"></select>
      </label>
      <label><input id="ck-stream" type="checkbox"/> 流式输出</label>
      <label><input id="ck-rag" type="checkbox"/> 启用 RAG</label>
      <span id="status" class="small muted">就绪</span>
    </div>

    <div id="chat" class="chat"></div>

    <div class="composer">
      <textarea id="input" placeholder="输入消息，Shift+Enter 换行，Enter 发送"></textarea>
      <!-- 圆形悬浮发送按钮（纸飞机图标） -->
      <button id="send" aria-label="发送">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M3.5 11.5L20 4l-7.5 16-2-7-7-1.5Z" stroke="white" stroke-width="1.8" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </main>
</div>

<script>
/** --------------- 配置与状态 --------------- */
const API = location.origin;
const USER_ID = 1;
const CHANNEL = "web";

let models = [];
let sessions = [];
let currentSessionId = null;     // 已在后端存在的会话 id
let currentBotName = null;
let pendingNew = true;           // 是否处于“本地新会话（尚未落库）”
let pendingBotName = null;       // 待创建会话使用的模型
let streamingReader = null;

/** --------------- 工具函数 --------------- */
const $ = s => document.querySelector(s);
const ce = (t, c) => {const el=document.createElement(t); if(c) el.className=c; return el;};
function setStatus(t){ $("#status").textContent = t; }
function scrollBottom(){ const c=$("#chat"); c.scrollTop=c.scrollHeight; }
function uiConfirm(message){
  return new Promise(resolve=>{
    const mask=$("#confirmMask");
    $("#confirmMsg").textContent = message || "确认吗？";
    const ok=$("#confirmOk"), cancel=$("#confirmCancel");
    const off=()=>{ mask.style.display="none"; ok.onclick=null; cancel.onclick=null; };
    ok.onclick=()=>{ off(); resolve(true); };
    cancel.onclick=()=>{ off(); resolve(false); };
    mask.style.display="flex";
  });
}
function hasUserOrAssistant() {
  const ns = [...document.querySelectorAll("#chat .msg")];
  return ns.some(n => n.classList.contains("user") || n.classList.contains("assistant"));
}

/** --------------- DOM 生成 --------------- */
function msgBubble(role, text){
  const wrap = ce("div", "msg " + role);
  const bubble = ce("div", "bubble");
  bubble.textContent = text || "";

  if(role === "assistant"){
    const av = ce("div", "avatar");
    const img = document.createElement("img");
    img.src = "/static/images/ai.jpg";
    img.alt = "AI";
    av.appendChild(img);
    wrap.appendChild(av);
    wrap.appendChild(bubble);
  }else if(role === "user"){
    wrap.appendChild(bubble);
    const av = ce("div", "avatar");
    const img = document.createElement("img");
    img.src = "/static/images/user.jpg";
    img.alt = "User";
    av.appendChild(img);
    wrap.appendChild(av);
  }else{ // system
    wrap.appendChild(bubble);
  }
  return wrap;
}

function renderSources(container, sources){
  if(!sources || !sources.length) return;
  const box = ce("div","sources");
  sources.forEach((s,i)=>{
    const line = ce("div","source-item");
    const title = s.title || `来源${i+1}`;
    const score = (typeof s.score==="number") ? `（${s.score}）` : "";
    if(s.url){
      const a = ce("a"); a.href=s.url; a.target="_blank"; a.rel="noreferrer"; a.textContent = title;
      line.appendChild(a);
    }else{
      const span = document.createElement("span");
      span.textContent = title;
      line.appendChild(span);
    }
    const sp = ce("span","score"); sp.textContent = score; line.appendChild(sp);
    if(s.snippet){
      const sn = ce("div","muted"); sn.style.marginTop="2px"; sn.textContent = s.snippet;
      line.appendChild(sn);
    }
    box.appendChild(line);
  });
  container.appendChild(box);
}

/** --------------- API --------------- */
async function apiGetModels(){
  const r = await fetch(`${API}/bots`);
  const j = await r.json();
  if(j.code !== 0) throw new Error(j.message||"bots failed");
  return j.data?.bots || [];
}
async function apiListSessions(){
  const r = await fetch(`${API}/sessions/list?user_id=${USER_ID}`, {method:"POST"});
  const j = await r.json();
  if(j.code !== 0) throw new Error(j.message||"list sessions failed");
  return j.data || [];
}
async function apiCreateSession(bot_name){
  const r = await fetch(`${API}/sessions/create`, {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ user_id: USER_ID, bot_name, channel: CHANNEL })
  });
  const j = await r.json();
  if(j.code !== 0) throw new Error(j.message||"create failed");
  return j.data.session_id;
}
async function apiDeleteSession(session_id){
  const r = await fetch(`${API}/sessions/delete?user_id=${USER_ID}&session_id=${encodeURIComponent(session_id)}`, {method:"POST"});
  const j = await r.json();
  if(j.code !== 0) throw new Error(j.message||"delete failed");
}
async function apiDeleteAll(){
  const r = await fetch(`${API}/sessions/delete_all?user_id=${USER_ID}`, {method:"POST"});
  const j = await r.json();
  if(j.code !== 0) throw new Error(j.message||"delete all failed");
}
async function apiHistory(session_id){
  const r = await fetch(`${API}/messages/history?user_id=${USER_ID}&session_id=${encodeURIComponent(session_id)}`);
  const j = await r.json();
  if(j.code !== 0) return [];
  return (j.data && j.data.history) || [];
}
async function apiPersistSystem(session_id, text, rag){
  await fetch(`${API}/messages/system?user_id=${USER_ID}&session_id=${encodeURIComponent(session_id)}&content=${encodeURIComponent(text)}${rag ? "&rag=1":""}`);
}
async function apiSendMessageJSON(session_id, role, content, rag_enabled){
  const r = await fetch(`${API}/messages/chat`, {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: USER_ID, session_id, content, role, stream: false,
      rag_enabled, channel: CHANNEL
    })
  });
  const j = await r.json();
  if(j.code !== 0) throw new Error(j.message||"send failed");
  return { reply: (j.data?.reply||""), sources: (j.data?.sources||[]) };
}
async function apiSendMessageStream(session_id, role, content, rag_enabled, onChunk){
  const r = await fetch(`${API}/messages/chat`, {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: USER_ID, session_id, content, role, stream: true,
      rag_enabled, channel: CHANNEL
    })
  });
  if(!r.ok){ let m="stream http error"; try{ const j=await r.json(); m=j.message||m;}catch{} throw new Error(m); }
  const reader = r.body.getReader();
  streamingReader = reader;
  const decoder = new TextDecoder("utf-8");
  while(true){
    const {done, value} = await reader.read();
    if(done) break;
    onChunk(decoder.decode(value,{stream:true}));
  }
  streamingReader = null;
}

/** --------------- 会话列表 --------------- */
async function reloadSessions(){
  sessions = await apiListSessions();
  const box = $("#session-list");
  box.innerHTML = "";
  $("#btn-clear-all").style.display = sessions.length ? "inline-block":"none";

  sessions.forEach(s=>{
    const item = ce("div","session-item"+(s.session_id===currentSessionId?" active":""));
    const title = ce("div","session-title");
    title.textContent = s.session_name || `[${s.bot_name}] 未命名`;

    const act = ce("div","session-actions");
    const del = ce("button","btn-del");
    del.type="button";
    del.title="删除会话";
    del.textContent="×";
    del.onclick = async(ev)=>{
      ev.stopPropagation();
      if(!await uiConfirm("确认删除该会话？")) return;
      await apiDeleteSession(s.session_id);
      if(currentSessionId===s.session_id){ currentSessionId=null; $("#chat").innerHTML=""; }
      await reloadSessions();
    };
    act.appendChild(del);

    item.appendChild(title);
    item.appendChild(act);

    item.onclick = async ()=>{
      if(currentSessionId===s.session_id && !pendingNew) return;
      pendingNew = false;
      currentSessionId = s.session_id;
      currentBotName = s.bot_name;
      $("#chat").innerHTML = "";
      await loadHistory(currentSessionId);
      renderSessionsActive();
    };

    box.appendChild(item);
  });
  renderSessionsActive();
}
function renderSessionsActive(){
  document.querySelectorAll(".session-item").forEach(n=>n.classList.remove("active"));
  if(!pendingNew && currentSessionId){
    const match = sessions.find(s=>s.session_id===currentSessionId);
    if(match){
      const idx = sessions.indexOf(match);
      const el = $("#session-list").children[idx];
      if(el) el.classList.add("active");
    }
  }
}

/** --------------- 历史渲染 --------------- */
async function loadHistory(sessionId){
  setStatus("加载历史…");
  const panel = $("#chat");
  panel.innerHTML = "";
  const hist = await apiHistory(sessionId);
  (hist||[]).forEach(m=>{
    const role = (typeof m.role==="string") ? m.role.toLowerCase() : "system";
    if(role==="system"){
      panel.appendChild(msgBubble("system", m.content||""));
    }else{
      const row = msgBubble(role, m.content||"");
      panel.appendChild(row);
      if(role==="assistant" && m.sources && m.sources.length){
        const bubble = row.querySelector(".bubble");
        renderSources(bubble, m.sources);
      }
    }
  });
  scrollBottom();
  setStatus("就绪");
}

/** --------------- 模型选择 --------------- */
function renderModels(){
  const sel = $("#model-select");
  sel.innerHTML = "";
  models.forEach(m=>{
    const opt = ce("option");
    opt.value = m.bot_name;
    opt.textContent = `${m.bot_name}（${m.family}）`;
    sel.appendChild(opt);
  });
  if(!currentBotName && models[0]) currentBotName = models[0].bot_name;
  if(currentBotName) sel.value = currentBotName;

  sel.onchange = async ()=>{
    const newModel = sel.value;
    if(hasUserOrAssistant()){
      const ok = await uiConfirm("当前会话已有聊天消息，切换模型将新建一个本地新会话。是否继续？");
      if(!ok){ sel.value = currentBotName; return; }
    }
    pendingNew = true;
    pendingBotName = newModel;
    currentSessionId = null;
    currentBotName = newModel;
    $("#chat").innerHTML = "";
    insertSystemTip(`已切换模型为 ${newModel}，已创建本地新会话（首次发送时将创建后端会话）。`);
  };
}

/** --------------- 系统提示：插入 + 持久化（若已有真实会话） --------------- */
async function insertSystemTip(text){
  $("#chat").appendChild(msgBubble("system", text));
  scrollBottom();
  if(!pendingNew && currentSessionId){
    try{ await apiPersistSystem(currentSessionId, text, $("#ck-rag").checked); }catch{}
  }
}
async function onFlagChanged(){
  const isStream = $("#ck-stream").checked;
  const isRag = $("#ck-rag").checked;
  const text = `${isStream? "已开启流式输出":"已关闭流式输出"} / ${isRag? "已开启RAG":"已关闭RAG"}`;
  await insertSystemTip(text);
}

/** --------------- 发送消息 --------------- */
async function ensureSessionIfNeeded(){
  if(!pendingNew) return currentSessionId;
  const model = pendingBotName || $("#model-select").value || models[0]?.bot_name;
  const sid = await apiCreateSession(model);
  pendingNew = false;
  currentSessionId = sid;
  currentBotName = model;
  await reloadSessions();
  return sid;
}
async function send(){
  const ta = $("#input");
  const text = (ta.value||"").trim();
  if(!text) return;

  const sessionId = await ensureSessionIfNeeded();

  const userRow = msgBubble("user", text);
  $("#chat").appendChild(userRow);
  scrollBottom();
  ta.value = "";

  const botRow = msgBubble("assistant", "");
  const bubble = botRow.querySelector(".bubble");
  $("#chat").appendChild(botRow);
  scrollBottom();

  const useStream = $("#ck-stream").checked;
  const useRag = $("#ck-rag").checked;

  setStatus(useStream ? "流式生成中…" : "生成中…");
  try{
    if(useStream){
      let full = "";
      await apiSendMessageStream(sessionId, "user", text, useRag, (chunk)=>{
        full += chunk;
        bubble.textContent = full;
        scrollBottom();
      });
      setStatus("就绪");
    }else{
      const {reply, sources} = await apiSendMessageJSON(sessionId, "user", text, useRag);
      bubble.textContent = reply || "";
      if(sources && sources.length){
        renderSources(bubble, sources);
      }
      setStatus("就绪");
    }
  }catch(e){
    bubble.textContent = `【错误】${e.message||e}`;
    setStatus("出错");
  }
}

/** --------------- 事件绑定 --------------- */
$("#send").onclick = send;
$("#input").addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});
$("#btn-new").onclick = async ()=>{
  const model = $("#model-select").value || models[0]?.bot_name;
  pendingNew = true;
  pendingBotName = model;
  currentSessionId = null;
  currentBotName = model;
  $("#chat").innerHTML = "";
  insertSystemTip(`已创建本地新会话（模型：${model}）。首次发送时会在后端真正创建。`);
  renderSessionsActive();
};
$("#btn-clear-all").onclick = async ()=>{
  if(!await uiConfirm("确认清空全部会话？")) return;
  await apiDeleteAll();
  sessions = [];
  currentSessionId = null;
  pendingNew = true;
  pendingBotName = $("#model-select").value || models[0]?.bot_name;
  $("#session-list").innerHTML = "";
  $("#chat").innerHTML = "";
  renderSessionsActive();
};
$("#ck-stream").onchange = onFlagChanged;
$("#ck-rag").onchange = onFlagChanged;

/** --------------- 初始化 --------------- */
(async function init(){
  try{
    models = await apiGetModels();
  }catch(e){ console.error(e); }
  renderModels();

  // 默认本地新会话（未落库）
  pendingNew = true;
  pendingBotName = $("#model-select").value || models[0]?.bot_name || "gpt-3.5-turbo";
  insertSystemTip(`已进入本地新会话（模型：${pendingBotName}）。首次发送时会创建后端会话。`);

  await reloadSessions(); // 左侧刷新，右侧保持当前视图
})();
</script>
</body>
</html>
